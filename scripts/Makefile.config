STAGING=staging.$(HOST_OS)
CONFIG=$(STAGING)/config
MCONF = $(CONFIG)/frontends/mconf/mconf
CONF = $(CONFIG)/frontends/conf/conf

# Well, we know our configure script is fine, but the timestamps may be all
# messed up after cloning, so we fix them once.
config/.fixup-autoconf-timestamps:
	$(Q)touch config/configure.ac
	$(Q)touch config/aclocal.m4
	$(Q)touch config/configure
	$(Q)touch config/Makefile.in
	$(Q)touch $@

$(CONFIG)/Makefile: config/.fixup-autoconf-timestamps
	@echo "Configuring kconfig-frontends"
	$(Q)mkdir -p $(CONFIG)
	$(Q)cd $(CONFIG) ; ../../config/configure $(if $(Q),-q)

$(MCONF): $(CONFIG)/Makefile
	@echo "Building $@"
	$(Q)make -C $(STAGING)/config $(if $(Q),> /dev/null)

$(CONF): $(CONFIG)/Makefile
	@echo "Building $@"
	$(Q)make -C $(STAGING)/config $(if $(Q),> /dev/null)

menuconfig: build_dir $(MCONF)
	$(Q)KCONFIG_CONFIG=$(BUILD)/.config $(MCONF) Kconfig

config: build_dir $(CONF)
	$(Q)KCONFIG_CONFIG=$(BUILD)/.config $(CONF) Kconfig

%_defconfig: build_dir $(CONF)
	@echo "*** Default configuration is based on '$@'"
	$(Q)KCONFIG_CONFIG=$(BUILD)/.config $(CONF) --defconfig=targets/$@ Kconfig

$(BUILD)/.config:
	$(Q)make menuconfig

-include $(BUILD)/auto.conf.cmd

$(BUILD)/auto.conf: $(CONF) $(BUILD)/.config
	$(Q)KCONFIG_AUTOCONFIG=$(BUILD)/auto.conf \
		KCONFIG_AUTOCONFIG_DEP=$(BUILD)/auto.conf.cmd \
		KCONFIG_TRISTATE=$(BUILD)/tristate.conf \
		KCONFIG_CONFIG=$(BUILD)/.config \
		KCONFIG_AUTOHEADER=$(BUILD)/autoconf.h $(CONF) --silentoldconfig Kconfig

$(BUILD)/autoconf.h: $(BUILD)/auto.conf
